# Remote Terminal Sync - Windows Host Service

.NET 8 Windows service that provides terminal access via WebSocket connections. Uses ConPTY for true terminal emulation with full support for PowerShell, CMD, and other console applications.

## Features

- **ConPTY Integration**: True Windows terminal emulation with perfect fidelity
- **WebSocket Server**: Secure TLS connections for terminal access
- **Multi-Shell Support**: PowerShell, CMD, Bash (WSL)
- **LAN Discovery**: mDNS/Bonjour advertising for automatic client discovery
- **Device Authentication**: Per-device key authentication with auto-registration
- **Windows Service**: Can run as system service or console application
- **Signal Handling**: Ctrl+C, Ctrl+Break signal forwarding
- **Dynamic Resizing**: Terminal window size changes

## Prerequisites

- **Windows 10 1903+** or **Windows 11** (required for ConPTY)
- **.NET 8 Runtime**
- **Developer Mode** enabled (for console applications)
- **Admin privileges** (for Windows service installation)

## Configuration

Create `config.yaml` from the example generated by certificate scripts:

```yaml
# Windows host service configuration
host_id: "550e8400-e29b-41d4-a716-446655440000"
host_token: "32-byte-hex-token-here"
port: 8443
default_shell: "powershell"
tls_cert_path: "../certs/host.crt"
tls_key_path: "../certs/host.key"
relay_url: "wss://localhost:8443"
discovery:
  enabled: true
  service_name: "_rtx._tcp"
  friendly_name: "My Windows Host"
pty:
  initial_cols: 120
  initial_rows: 30
  buffer_size: 8192
log_level: "Information"
auto_register_devices: true
```

### Configuration Options

**Core Settings:**
- `host_id`: Unique identifier for this host (UUID format)
- `host_token`: Authentication token for relay connections
- `port`: WebSocket server port (default: 8443)
- `default_shell`: Default shell to launch ("powershell", "cmd", "bash")

**TLS Settings:**
- `tls_cert_path`: Path to TLS certificate file
- `tls_key_path`: Path to TLS private key file

**Discovery Settings:**
- `discovery.enabled`: Enable mDNS advertising
- `discovery.service_name`: mDNS service name
- `discovery.friendly_name`: Human-readable host name

**Terminal Settings:**
- `pty.initial_cols`: Default terminal width
- `pty.initial_rows`: Default terminal height
- `pty.buffer_size`: WebSocket buffer size

**Security Settings:**
- `auto_register_devices`: Auto-register new devices (development mode)
- `log_level`: Logging verbosity

## Building

### Development Build

```powershell
# Build for current platform
dotnet build

# Build release version
dotnet build --configuration Release

# Run tests
dotnet test
```

### Production Build

```powershell
# Self-contained deployment
dotnet publish -c Release -r win-x64 --self-contained

# Framework-dependent deployment (requires .NET 8 runtime)
dotnet publish -c Release
```

## Running

### Console Application (Development)

```powershell
# Run from source
dotnet run --project src/HostService

# Run from built executable
./bin/Release/net8.0-windows/HostService.exe
```

### Windows Service (Production)

```powershell
# Install service
sc create RTXHost binPath="C:\RTX\HostService.exe" start=auto
sc description RTXHost "Remote Terminal Sync Host Service"

# Configure service to restart on failure
sc failure RTXHost reset=86400 actions=restart/5000/restart/10000/restart/30000

# Start service
sc start RTXHost

# Check service status
sc query RTXHost

# Stop and remove service
sc stop RTXHost
sc delete RTXHost
```

### Service Account Configuration

For production use, run the service under a dedicated account:

```powershell
# Create service account
net user RTXService /add /passwordreq:no /active:yes /comment:"RTX Host Service Account"
net localgroup "Log on as a service" RTXService /add

# Configure service to use the account
sc config RTXHost obj=.\RTXService
```

## Shell Support

### PowerShell (Recommended)

```yaml
default_shell: "powershell"
```

- Full PSReadLine support
- History navigation (Up/Down arrows)
- Tab completion
- Command editing
- Syntax highlighting

### Command Prompt

```yaml
default_shell: "cmd"
```

- Basic command prompt functionality
- Command history (F7 menu)
- Tab completion for files
- Batch file execution

### Bash (WSL)

```yaml
default_shell: "bash"
```

- Requires Windows Subsystem for Linux
- Full bash functionality
- Linux command support

## Protocol Messages

The service handles these WebSocket message types:

### Authentication
```json
{
  "type": "auth",
  "device_key": "64-char-hex-device-key",
  "host_id": "target-host-uuid",
  "client_version": "1.0.0"
}
```

### Terminal Input
```json
{
  "type": "stdin_input",
  "mode": "text",
  "data": "ls\r\n"
}
```

### VT Sequences
```json
{
  "type": "stdin_input",
  "mode": "vt",
  "data": "\u001b[A"
}
```

### Terminal Resize
```json
{
  "type": "resize",
  "cols": 120,
  "rows": 40
}
```

### Signal
```json
{
  "type": "signal",
  "name": "INT"
}
```

## Device Management

### Device Registry

Devices are stored in `DeviceRegistry.json`:

```json
{
  "64-char-hex-device-key": {
    "DeviceKey": "64-char-hex-device-key",
    "FriendlyName": "Android Device",
    "FirstSeen": "2024-01-15T10:30:00Z",
    "LastSeen": "2024-01-15T12:45:00Z",
    "IsRevoked": false
  }
}
```

### Manual Device Management

```powershell
# Auto-registration (development mode)
# Devices are automatically registered on first connection

# Manual device registration (production)
# Add device key to DeviceRegistry.json manually
# Or use management API (when implemented)

# Revoke device access
# Set "IsRevoked": true in DeviceRegistry.json
```

## Security

### Authentication Flow

1. Client connects to WebSocket endpoint
2. Client sends `auth` message with device key
3. Host validates device key against registry
4. If valid, host creates ConPTY session and sends `auth_ok`
5. Terminal session begins

### Network Security

- **TLS 1.2+**: All connections encrypted
- **Certificate Validation**: Clients must pin host certificates
- **No Plaintext**: All terminal data encrypted in transit

### Access Control

- **Device Keys**: 256-bit random keys per device
- **Host Tokens**: 256-bit random tokens per host
- **Revocation**: Instant device access revocation
- **Audit Trail**: All connections logged with timestamps

## Monitoring

### Logging

Logs are written to:
- **Console**: When running as console application
- **Windows Event Log**: When running as Windows service
- **Log Files**: `logs/rtx-host-YYYY-MM-DD.txt`

### Log Levels

```yaml
log_level: "Debug"    # Verbose debugging
log_level: "Information"  # Normal operations
log_level: "Warning"  # Problems that don't stop service
log_level: "Error"    # Errors that affect functionality
```

### Performance Monitoring

Monitor these metrics:
- Active WebSocket connections
- ConPTY process memory usage
- Terminal output buffer sizes
- Connection establishment times

## Troubleshooting

### Common Issues

**ConPTY Creation Fails**
```
Error: Failed to create pseudo console: 0x80070057
```
- Ensure Windows 10 1903+ or Windows 11
- Enable Developer Mode in Windows Settings
- Run as Administrator if needed

**WebSocket Connection Refused**
```
Error: Connection refused on port 8443
```
- Check Windows Firewall rules
- Verify TLS certificate paths
- Ensure port not in use by other applications

**Device Authentication Failed**
```
Error: Device not authorized
```
- Verify device key in DeviceRegistry.json
- Check `auto_register_devices` setting
- Ensure device key format (64-char hex)

**Terminal Output Corruption**
```
Garbled characters or ANSI sequences
```
- Verify UTF-8 encoding in terminal
- Check console code page: `chcp 65001`
- Ensure PSReadLine is up to date

### Diagnostic Commands

```powershell
# Check ConPTY availability
[System.Environment]::OSVersion.Version

# Test certificate loading
openssl x509 -in host.crt -text -noout

# Verify firewall rules
netsh advfirewall firewall show rule name="RTX Host"

# Check service status
Get-Service RTXHost | Format-List *

# Monitor WebSocket connections
netstat -an | findstr :8443
```

### Debug Mode

Enable verbose logging for troubleshooting:

```yaml
log_level: "Debug"
```

This will log:
- All WebSocket messages
- ConPTY process creation details
- Device authentication attempts
- Terminal resize operations
- Signal handling

## Development

### Running Tests

```powershell
# Run all tests
dotnet test

# Run specific test category
dotnet test --filter "Category=Unit"

# Run with verbose output
dotnet test --logger "console;verbosity=detailed"

# Generate coverage report
dotnet test --collect:"XPlat Code Coverage"
```

### Adding New Shells

1. Add shell command to `GetShellCommand()` in `WebSocketHost.cs`
2. Test ConPTY compatibility
3. Update configuration documentation
4. Add tests for new shell type

### Protocol Extensions

1. Add new message types to `Messages.cs`
2. Handle messages in `WebSocketHost.cs`
3. Update protocol documentation
4. Add corresponding tests

## License

MIT License - see root LICENSE file for details.